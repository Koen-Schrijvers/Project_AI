<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Client</title>
    <style>
        #data-container {
            margin-top: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table,
        th,
        td {
            border: 1px solid black;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }
        .containerDiv{
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-gap: 20px;

            border-radius: 10px 10px 10px 10px;
            box-shadow: -4px 0px 4px rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-style: groove;
            border-width: 5px;

        }
    </style>
</head>

<body>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <h1>Dashboard Geluidssensor</h1>
    <button id="connectButton">Connect</button>
    <button id="stopButton">Stop</button>
    <br><br>

    <div class="containerDiv">


        <div style="display: flex; align-items: flex-end;">
            <div id="barGraph"
                style="width: 50px; height: 300px; background-color: lightgray; position: relative; border-radius: 10px 10px 10px 10px; box-shadow: -4px 0px 4px rgba(0, 0, 0, 0.2);">
                <div id="bar"
                    style="width: 100%; height: 0%; background-color: blue; position: absolute; bottom: 0; border-radius: 10px 10px 10px 10px;">
                </div>
            </div>

            <span id="latestDBA" style="margin-left: 10px; margin-bottom: 15%;"></span>
        </div>

        <canvas id="lineGraph" width="200" height="100"></canvas>

    </div>


    <div id="data-container">
        <table id="dataTable">
            <thead>
                <!-- Table header will be populated dynamically -->
            </thead>
            <tbody>
                <!-- Table data will be populated dynamically -->
            </tbody>
        </table>
    </div>




    <script>
        var ws;

        // Initialize variables for the line graph
        let lineGraphCtx = document.getElementById('lineGraph').getContext('2d');
        let lineGraphData = {
            labels: [],  // X-axis labels (timestamps)
            datasets: [{
                label: 'Sound Level (dBA)',
                data: [],  // Y-axis data points (dBA values)
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1,
                fill: false
            }]
        };
        let lineGraphConfig = {
            type: 'line',
            data: lineGraphData,
            options: {
                scales: {
                    x: {
                        type: 'linear',
                        position: 'bottom'
                    }
                }
            }
        };
        let lineGraph = new Chart(lineGraphCtx, lineGraphConfig);


        document.getElementById('connectButton').addEventListener('click', () => {
            ws = new WebSocket('ws://localhost:8080');

            ws.addEventListener('open', () => {
                console.log('Connected to server');
                ws.send('Hello, server!');
            });

            ws.addEventListener('message', (event) => {
                console.log(`Received message: ${event.data}`);

                const data = JSON.parse(event.data);

                if (!data) return;

                const dataTable = document.getElementById('dataTable');

                // Populate table header dynamically
                if (dataTable.tHead.rows.length === 0) {
                    const thead = dataTable.createTHead();
                    const row = thead.insertRow();

                    ["timestamp", "dBA"].forEach(key => {
                        const th = document.createElement("th");
                        const text = document.createTextNode(key);
                        th.appendChild(text);
                        row.appendChild(th);
                    });
                }

                // Append received data to the table
                const row = dataTable.insertRow();

                ["timestamp", "dBA"].forEach(key => {
                    const cell = row.insertCell();
                    const text = document.createTextNode(data[key]);
                    cell.appendChild(text);
                });

                // Update the bar graph
                const bar = document.getElementById('bar');
                const maxGraphHeight = 300; // match the height of #barGraph in CSS

                const minDBA = 40;
                const maxDBA = 80;
                let normalizedDBA = (data.dBA - minDBA) / (maxDBA - minDBA);
                if (normalizedDBA < 0) normalizedDBA = 0;
                if (normalizedDBA > 1) normalizedDBA = 1;

                bar.style.height = `${normalizedDBA * 100}%`;

                // Update the color based on the dBA value
                if (data.dBA > 75) {
                    bar.style.backgroundColor = 'red';
                } else if (data.dBA > 68) {
                    bar.style.backgroundColor = 'orange';
                } else {
                    bar.style.backgroundColor = 'green';
                }

                // Update the latest dBA value display
                document.getElementById('latestDBA').innerText = `Latest dBA: ${data.dBA}`;

                // Update the line graph
                // if (lineGraphData.labels.length > 60) {  // keep only the last 60 data points
                //     lineGraphData.labels.shift();
                //     lineGraphData.datasets[0].data.shift();
                // }
                //const unixTimestamp = convertToUnixTimestamp(data.timestamp);
                //lineGraphData.labels.push(unixTimestamp);
                lineGraphData.labels.push(counter++)
                lineGraphData.datasets[0].data.push(data.dBA);
                lineGraph.update();


            });

            var counter = 0;

            function convertToUnixTimestamp(str) {
                // Extracting date and time from the string
                const [date, time] = str.split(' ');
                const [year, month, day] = date.split('-').map(Number);
                const [hour, minute, second] = time.split(':').map(Number);

                // Creating a Date object
                const dateObj = new Date(year, month - 1, day, hour, minute, second);

                // Returning the Unix timestamp (in seconds)
                return dateObj.getTime();
            }





            ws.addEventListener('close', () => {
                console.log('Disconnected from server');
            });

            ws.addEventListener('error', (error) => {
                console.log('An error occurred:', error);
            });
        });

        document.getElementById('stopButton').addEventListener('click', () => {
            console.log('Stopping the client');
            if (ws) {
                ws.close();
            }
        });
    </script>

</body>

</html>